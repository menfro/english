<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JET 4 - ×¦×™×™×“×•×ª ×”×©×“×™× ×©×œ ×”×§×™×™-×¤×•×¤</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Rubik', sans-serif;
      background-color: #1a1a2e;
      color: #e2e8f0;
      min-height: 100vh;
    }
    .app-container { direction: rtl; }
    .game-card {
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }
    .game-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      border-color: #a855f7;
    }
    .selected {
      border-color: #f472b6;
      box-shadow: 0 0 15px rgba(244, 114, 182, 0.6);
      transform: scale(1.02);
      background-color: rgba(244, 114, 182, 0.1);
    }
    .correct-match {
      background-color: #065f46 !important;
      border-color: #34d399 !important;
      color: #ecfdf5 !important;
      animation: pulse-green 0.5s;
    }
    .incorrect-match {
      background-color: #7f1d1d !important;
      border-color: #f87171 !important;
      color: #fef2f2 !important;
      animation: shake 0.4s;
    }
    @keyframes pulse-green {
      0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); }
      100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .stage-locked { opacity: 0.5; filter: grayscale(100%); pointer-events: none; }
    
    /* Flip Card Styles */
    .transform-style-3d { transform-style: preserve-3d; } 
    .backface-hidden { backface-visibility: hidden; } 
    .rotate-y-180 { transform: rotateY(180deg); }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
  </style>
</head>

<body class="p-4 flex flex-col items-center">
  <div id="app-container" class="app-container w-full max-w-4xl bg-gray-900 p-6 md:p-8 rounded-2xl shadow-2xl mt-4 border border-gray-700">

    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-2 drop-shadow-lg">
        âš”ï¸ ×¦×™×™×“×•×ª ×”×©×“×™× ×©×œ ×”-K-Pop
      </h1>
      <p id="app-subtitle" class="text-gray-400 text-lg">
        ×”×©×ª××©×™ ×‘×× ×’×œ×™×ª ×›×“×™ ×œ×’×¨×© ×¨×•×—×•×ª, ×œ×¤×¨×•×¥ ×—×•×ª××•×ª, ×•×œ×”×¦×™×œ ××ª ×”××™×™×“×•×œ×™×.
      </p>
    </header>

    <!-- Status Bar -->
    <div id="status-bar" class="grid grid-cols-3 gap-3 mb-4 bg-gray-800 p-4 rounded-xl border border-gray-700">
      <div class="flex flex-col">
        <span class="text-xs text-gray-500 uppercase tracking-wider">× ×™×§×•×“ × ×©××•×ª</span>
        <span id="current-score" class="text-2xl font-bold text-pink-500">0</span>
      </div>
      <div class="flex flex-col">
        <span class="text-xs text-gray-500 uppercase tracking-wider">×©×™× ×¦×™×™×“×ª</span>
        <span id="high-score" class="text-2xl font-bold text-purple-500">...</span>
      </div>
      <div class="flex flex-col">
        <span class="text-xs text-gray-500 uppercase tracking-wider">Relics</span>
        <span id="relics-count" class="text-2xl font-bold text-emerald-400">0</span>
      </div>
    </div>

    <div class="text-xs text-center text-gray-600 mb-4" id="user-id-display">××¦×‘: ××ª×—×‘×¨ ×œ××¡×“×¨ ×”×¦×™×™×“×•×ª...</div>

    <!-- VIEWS Container -->
    <div id="views-container" class="relative min-h-[420px]">

      <!-- MAP VIEW -->
      <div id="map-view" class="view">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-300 flex items-center gap-2">
            <span class="text-2xl">ğŸ—ºï¸</span> ××¤×ª ×”×¢×•×œ××•×ª
          </h2>
          <div class="flex gap-2">
            <button onclick="AdventureGame.toggleHardMode()" class="px-4 py-2 rounded-xl bg-gray-800 border border-gray-700 text-gray-300 hover:bg-gray-700 transition font-bold text-sm">
              ğŸ§¨ ××¦×‘ ×§×©×”: <span id="hard-mode-ind">×›×‘×•×™</span>
            </button>
            <button onclick="AdventureGame.resetLocal()" class="px-4 py-2 rounded-xl bg-gray-800 border border-gray-700 text-gray-300 hover:bg-gray-700 transition font-bold text-sm">
              â™»ï¸ ××™×¤×•×¡ ××§×•××™
            </button>
          </div>
        </div>

        <div id="worlds-list" class="space-y-4"></div>
      </div>

      <!-- NARRATIVE VIEW -->
      <div id="stage-challenge-view" class="view hidden">
        <div class="bg-gray-800 rounded-2xl overflow-hidden shadow-xl border border-gray-700">
          <div class="relative h-48 bg-gray-900 overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 to-transparent z-10"></div>
            <img id="stage-character-img" class="w-full h-full object-cover opacity-80" alt="Demon" src="">
            <div class="absolute bottom-4 right-4 z-20 text-right">
              <h2 id="stage-title" class="text-3xl font-black text-white drop-shadow-md"></h2>
              <p id="stage-meta" class="text-sm text-gray-300 mt-1"></p>
            </div>
          </div>

          <div class="p-6 md:p-8">
            <div class="flex items-start gap-4 mb-6">
              <span class="text-4xl">ğŸ“œ</span>
              <p id="stage-narrative" class="text-lg text-gray-300 leading-relaxed"></p>
            </div>

            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700 mb-6">
              <h3 class="text-pink-400 font-bold mb-2 uppercase text-sm tracking-widest">×”××©×™××” ×©×œ×š</h3>
              <p id="challenge-instructions" class="text-xl font-bold text-white"></p>
              <p id="challenge-tip" class="text-sm text-gray-300 mt-2"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-8">
              <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                <div class="text-xs text-gray-500 uppercase tracking-wider">×¤×¨×¡</div>
                <div id="reward-text" class="text-lg font-bold text-emerald-300"></div>
              </div>
              <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                <div class="text-xs text-gray-500 uppercase tracking-wider">×¡×™×›×•×Ÿ</div>
                <div id="risk-text" class="text-lg font-bold text-amber-300"></div>
              </div>
              <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                <div class="text-xs text-gray-500 uppercase tracking-wider">×‘×•× ×•×¡ Relic</div>
                <div id="relic-bonus-text" class="text-lg font-bold text-cyan-300"></div>
              </div>
            </div>

            <div class="flex gap-4 justify-center">
              <button onclick="AdventureGame.showView('map-view')" class="px-6 py-3 rounded-xl bg-gray-700 text-gray-300 hover:bg-gray-600 transition font-bold">
                ×‘×™×˜×•×œ
              </button>
              <button onclick="AdventureGame.startChallenge()" class="px-8 py-3 rounded-xl bg-gradient-to-r from-pink-600 to-purple-600 text-white hover:from-pink-500 hover:to-purple-500 shadow-lg shadow-purple-900/50 transition transform hover:scale-105 font-bold flex items-center gap-2">
                âš”ï¸ ×”×ª×—×œ×™ ×§×¨×‘!
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- GAME VIEW -->
      <div id="game-view" class="view hidden">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 id="game-title" class="text-xl font-bold text-gray-200"></h2>
            <p id="game-subtitle" class="text-sm text-gray-400"></p>
          </div>
          <button onclick="AdventureGame.showView('stage-challenge-view')" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-red-600 text-gray-200 text-sm font-bold transition flex items-center gap-2">
            ğŸ”™ ×™×¦×™××”
          </button>
        </div>

        <!-- Boss Bar (hidden unless boss) -->
        <div id="boss-bar" class="hidden mb-4 bg-gray-800 border border-gray-700 rounded-xl p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold text-pink-300" id="boss-name">×‘×•×¡</div>
            <div class="text-xs text-gray-400" id="boss-phase">×©×œ×‘ 1</div>
          </div>
          <div class="w-full h-3 bg-gray-900 rounded-full overflow-hidden border border-gray-700">
            <div id="boss-hp" class="h-full bg-gradient-to-r from-pink-600 to-purple-600" style="width: 100%"></div>
          </div>
        </div>

        <div id="game-content" class="flex flex-col items-center justify-center w-full"></div>

        <!-- Feedback Area -->
        <div class="mt-8 text-center min-h-[60px]">
          <p id="feedback-message" class="text-2xl font-bold transition-all duration-300"></p>
        </div>

        <div class="flex justify-center gap-4 mt-2">
          <button id="next-button" class="hidden px-8 py-3 bg-green-600 text-white rounded-xl shadow-lg hover:bg-green-500 transition font-bold">
            ×”××©×š â”
          </button>
          <button id="end-quiz-button" class="hidden px-8 py-3 bg-purple-600 text-white rounded-xl shadow-lg hover:bg-purple-500 transition font-bold" onclick="window.GameQuiz.finishQuiz()">
            ×¡×™×™× ×•×§×‘×œ ×¦×™×•×Ÿ
          </button>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div id="loading-overlay" class="absolute inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mb-4"></div>
        <p class="text-pink-400 font-bold">×˜×•×¢×Ÿ ×œ×—×©×™×...</p>
      </div>

    </div>
  </div>

  <!-- Firebase & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // -----------------------------
    // DATA: WORLDS + STAGES (x12)
    // -----------------------------
    const WORLDS = [
      {
        worldId: "W1",
        title: "×¢×•×œ× 1 - ×”××•×œ×¤×Ÿ ×”×¨×“×•×£",
        tagline: "×”×›×œ ××ª×—×™×œ ×‘×—×–×¨×•×ª... ×•××– ××™×©×”×• ×œ×•×—×©: 'No English, no music.'",
        icon: "ğŸ§",
        stages: [
          {
            stageId: 1,
            worldId: "W1",
            title: "×—×“×¨ ×”×—×–×¨×•×ª ×”×¨×“×•×£",
            narrative: "×©×“ ×”×‘×œ×‘×•×œ ××©×‘×© ××ª ×©××•×ª ×”×—×¤×¦×™×. ×›×“×™ ×œ×’×¨×© ××•×ª×•, ×”×ª××™××™ ××ª ×”××™×œ×™× ×”× ×›×•× ×•×ª ×œ×—×¤×¦×™× ××”×¨.",
            characterImage: "https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?q=80&w=1200&auto=format&fit=crop",
            challengeType: "match",
            reward: { souls: 220, relic: false },
            risk: "×˜×¢×•×™×•×ª ××•×¨×™×“×•×ª × ×§×•×“×•×ª",
            tip: "×‘×—×¨×™ ×–×•×’ ××—×“ ×‘×× ×’×œ×™×ª ×•×–×•×’ ××—×“ ×‘×¢×‘×¨×™×ª - ××•×ª×• ID.",
            unitData: {
              vocabulary: [
                { id: 101, en: "teacher", he: "××•×¨×” (×œ×¨×™×§×•×“)" },
                { id: 102, en: "friend", he: "×—×‘×¨×” ×œ×œ×”×§×”" },
                { id: 103, en: "desk", he: "×©×•×œ×—×Ÿ ××™×¤×•×¨" },
                { id: 104, en: "chair", he: "×›×™×¡×" },
                { id: 105, en: "bag", he: "×ª×™×§ ××™××•×Ÿ" },
                { id: 106, en: "class", he: "×©×™×¢×•×¨" }
              ]
            },
            successMessage: "×”×©×“ ×’×•×¨×©! ×—×“×¨ ×”×—×–×¨×•×ª × ×§×™. ×§×™×‘×œ×ª × ×©××•×ª!"
          },
          {
            stageId: 2,
            worldId: "W1",
            title: "×—×•×˜×™ ×”××™×§×¨×•×¤×•×Ÿ ×”××§×•×œ×œ×™×",
            narrative: "×§×•×•×™ ×”×¡××•× ×“ × × ×¢×œ×• ×‘×§×¡×. ×¨×§ ×›×ª×™×‘×” ××“×•×™×§×ª ×ª×¤×¨×•× ××ª ×”×§×©×¨×™×.",
            characterImage: "https://images.unsplash.com/photo-1521337706264-a414f153a5a6?q=80&w=1200&auto=format&fit=crop",
            challengeType: "typing",
            reward: { souls: 260, relic: true, relicName: "Shard of Clarity" },
            risk: "×˜×™×™××¨ ×§×¦×¨ (×‘××¦×‘ ×§×©×”)",
            tip: "×”×©×œ×™××™ ××ª ×”××™×œ×” ×”×—×¡×¨×” ×‘×× ×’×œ×™×ª ×‘×œ×™ ×©×’×™××•×ª.",
            unitData: {
              typing: [
                { prompt: "I put my mic in my ____.", answer: "bag", hint: "×ª×™×§" },
                { prompt: "We practice dance in the ____.", answer: "class", hint: "×©×™×¢×•×¨" },
                { prompt: "Sit on the ____.", answer: "chair", hint: "×›×™×¡×" },
                { prompt: "My ____ helps me.", answer: "friend", hint: "×—×‘×¨×”" }
              ]
            },
            successMessage: "×”×§×©×¨×™× × ×¤×¨××•! ×§×•×•×™ ×”×¡××•× ×“ ×—×–×¨×• ×œ×¢×‘×•×“."
          },
          {
            stageId: 3,
            worldId: "W1",
            title: "××œ×›×•×“×ª ×”×”××–× ×” ×©×œ ×”×”×“",
            narrative: "×¨×•×— ×”×”×“ ××—×§×” ×§×•×œ×•×ª. ×›×“×™ ×œ×‘×¨×•×—, ×¢×œ×™×™×š ×œ×–×”×•×ª ××ª ×”××™×œ×” ×©×©××¢×ª.",
            characterImage: "https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=1200&auto=format&fit=crop",
            challengeType: "listening",
            reward: { souls: 280, relic: false },
            risk: "×‘×œ×‘×•×œ ×‘×™×Ÿ ××™×œ×™× ×“×•××•×ª",
            tip: "×œ×—×¦×™ '×”×©××¢×”' ×•××– ×‘×—×¨×™ ××ª ×”××™×œ×” ×©×©××¢×ª.",
            unitData: {
              listening: [
                { word: "teacher", options: ["teacher", "chair", "desk"] },
                { word: "morning", options: ["evening", "morning", "friend"] },
                { word: "desk", options: ["bag", "desk", "class"] },
                { word: "chair", options: ["teacher", "chair", "class"] }
              ]
            },
            successMessage: "×©××¢×ª × ×›×•×Ÿ! ×”×”×“ × ×©×‘×¨."
          },
          {
            stageId: 4,
            worldId: "W1",
            title: "×‘×•×¡ ×¢×•×œ× 1 - ×©×“ ×”×ª×“×¨×™× (The Frequency Fiend)",
            narrative: "×”×‘×•×¡ ××–××–× ×ª×“×¨ ×©×’×•×¨× ×œ××™×œ×™× ×œ×”×ª×‘×œ×‘×œ. ×¨×§ ×§×¨×‘ ×¨×‘-×©×œ×‘×™ ×™×©×‘×•×¨ ××ª ×”×§×¡×: ×”×ª×××•×ª ×•××– ×©××œ×•×Ÿ ×‘×–×§.",
            characterImage: "https://images.unsplash.com/photo-1516280440614-37939bbacd81?q=80&w=1200&auto=format&fit=crop",
            challengeType: "boss",
            boss: { name: "The Frequency Fiend", phases: 2, hp: 100 },
            reward: { souls: 500, relic: true, relicName: "Crown of Signal" },
            risk: "×¢× ×™×©×” ×—×–×§×” ×¢×œ ×˜×¢×•×™×•×ª",
            tip: "×ª× ×¦×—×™ ×©×œ×‘ 1 (Match) ×•××– ×©×œ×‘ 2 (Quiz).",
            unitData: {
              boss: {
                phase1: {
                  type: "match",
                  vocabulary: [
                    { id: 111, en: "morning", he: "×‘×•×§×¨" },
                    { id: 112, en: "evening", he: "×¢×¨×‘" },
                    { id: 113, en: "bag", he: "×ª×™×§" },
                    { id: 114, en: "desk", he: "×©×•×œ×—×Ÿ" }
                  ]
                },
                phase2: {
                  type: "quiz",
                  quiz: [
                    { q: "My ____ teaches me.", a: "teacher", options: ["teacher", "bag", "chair"], tip: "××™ ××œ××“?" },
                    { q: "We sit on a ____.", a: "chair", options: ["desk", "chair", "class"], tip: "××™×¤×” ×™×•×©×‘×™×?" },
                    { q: "In the ____ we practice.", a: "class", options: ["class", "kitchen", "house"], tip: "××™×¤×” ××ª××× ×™×?" }
                  ]
                }
              }
            },
            successMessage: "×”×ª×“×¨ × ×©×‘×¨! ×”××•×œ×¤×Ÿ × ×™×¦×œ."
          }
        ]
      },

      {
        worldId: "W2",
        title: "×¢×•×œ× 2 - ×”××¢×•× ×•×ª ×•×”××¡×“×¨×•× ×•×ª",
        tagline: "×“×œ×ª×•×ª × ×¡×’×¨×•×ª. ×©×œ×˜×™× ×–×–×™×. ×•×¨×§ ××©×¤×˜ ××—×“ × ×›×•×Ÿ ×¤×•×ª×— ×× ×¢×•×œ.",
        icon: "ğŸ¢",
        stages: [
          {
            stageId: 5,
            worldId: "W2",
            title: "×”××¢×•× ×•×ª ×”××§×•×œ×œ×™×",
            narrative: "×¨×•×— ×¢×ª×™×§×” × ×¢×œ×” ××ª ×”×“×œ×ª×•×ª. ×”×™× ×“×•×¨×©×ª ×©×™× ×•×Ÿ ×©×œ ××™×œ×™× ×¢×œ ×‘×™×ª ×•××©×¤×—×”.",
            characterImage: "https://images.unsplash.com/photo-1555854877-bab0e564b8d5?q=80&w=1200&auto=format&fit=crop",
            challengeType: "flashcards",
            reward: { souls: 320, relic: false },
            risk: "××™×Ÿ",
            tip: "×”×¤×›×™ ×›×¨×˜×™×¡, ×”×©××¢×”, ×•××– '×”×‘×'.",
            unitData: {
              vocabulary: [
                { id: 201, en: "mother", he: "×××" },
                { id: 202, en: "father", he: "××‘×" },
                { id: 203, en: "house", he: "×‘×™×ª" },
                { id: 204, en: "kitchen", he: "××˜×‘×—" },
                { id: 205, en: "eat", he: "×œ××›×•×œ" },
                { id: 206, en: "sleep", he: "×œ×™×©×•×Ÿ" },
                { id: 207, en: "brother", he: "××—" },
                { id: 208, en: "sister", he: "××—×•×ª" }
              ]
            },
            successMessage: "×”×“×œ×ª×•×ª × ×¤×ª×—×•. ×”×¨×•×— × ×¨×’×¢×”."
          },
          {
            stageId: 6,
            worldId: "W2",
            title: "×“×•-×§×¨×‘ ××¡×“×¨×•×Ÿ (Dialogue Duel)",
            narrative: "×©×“ ×”×—×™×§×•×™ ××ª×—×–×” ×œ××™×™×“×•×œ. ×ª× ×¦×—×™ ××•×ª×• ×‘×©×™×—×”: ×‘×—×¨×™ ××ª ×”×ª×’×•×‘×” ×”× ×›×•× ×” ×‘×× ×’×œ×™×ª.",
            characterImage: "https://images.unsplash.com/photo-1520975958225-7f61d8d0f06b?q=80&w=1200&auto=format&fit=crop",
            challengeType: "dialogue",
            reward: { souls: 360, relic: true, relicName: "Mask of Politeness" },
            risk: "×ª×’×•×‘×” ×©×’×•×™×” ××•×¨×™×“×” × ×§×•×“×•×ª",
            tip: "×©×™××™ ×œ×‘ ×œ× ×™××•×¡ (please, thanks) ×•×œ××™×œ×•×ª ×§×™×©×•×¨ (because, but).",
            unitData: {
              dialogue: [
                {
                  npc: "Stranger",
                  line: "Hi! Are you new here?",
                  options: [
                    { text: "Yes, I am. Nice to meet you.", correct: true },
                    { text: "Kitchen bag teacher.", correct: false },
                    { text: "No, sleep desk.", correct: false }
                  ]
                },
                {
                  npc: "Stranger",
                  line: "Where is the kitchen?",
                  options: [
                    { text: "It is on the first floor.", correct: true },
                    { text: "I am a sister.", correct: false },
                    { text: "Good evening bag.", correct: false }
                  ]
                },
                {
                  npc: "Stranger",
                  line: "Do you want to eat now?",
                  options: [
                    { text: "Yes, please. I'm hungry.", correct: true },
                    { text: "Teacher chair.", correct: false },
                    { text: "No, class desk.", correct: false }
                  ]
                }
              ]
            },
            successMessage: "×”×ª×—×–×•×ª × ×—×©×¤×”. ×”××¡×“×¨×•×Ÿ × ×§×™."
          },
          {
            stageId: 7,
            worldId: "W2",
            title: "×—×•×ª× ×”×›×ª×™×‘×” ×”××”×™×¨×”",
            narrative: "×“×œ×ª ×‘×¨×–×œ ×¢× ×—×•×ª× ×“×•×¨×©×ª ×”×©×œ××” ×©×œ ××©×¤×˜×™× ×‘×¡×™×¡×™×™× ×¢×œ ××©×¤×—×” ×•×‘×™×ª.",
            characterImage: "https://images.unsplash.com/photo-1529070538774-1843cb3265df?q=80&w=1200&auto=format&fit=crop",
            challengeType: "typing",
            reward: { souls: 380, relic: false },
            risk: "×‘××¦×‘ ×§×©×” - 2 ×˜×¢×•×™×•×ª ×¡×•×’×¨×•×ª ××ª ×”×“×œ×ª",
            tip: "×”×§×œ×“×” ××“×•×™×§×ª ×‘×œ×‘×“ - ×‘×œ×™ ×¨×•×•×—×™× ××™×•×ª×¨×™×.",
            unitData: {
              typing: [
                { prompt: "My ____ is at home.", answer: "mother", hint: "×××" },
                { prompt: "We ____ in the kitchen.", answer: "eat", hint: "×œ××›×•×œ" },
                { prompt: "I ____ at night.", answer: "sleep", hint: "×œ×™×©×•×Ÿ" }
              ]
            },
            successMessage: "×”×—×•×ª× × ×©×‘×¨. ×”×“×œ×ª × ×¤×ª×—×”."
          },
          {
            stageId: 8,
            worldId: "W2",
            title: "×‘×•×¡ ×¢×•×œ× 2 - ×©×“ ×”× ×™××•×¡×™× (The Etiquette Wraith)",
            narrative: "×”×‘×•×¡ ××¢× ×™×© ×›×œ ××©×¤×˜ ×œ× ×× ×•××¡. ×ª×¦×˜×¨×›×™ ×œ× ×¦×— ×“×™××œ×•×’ ×•××– ××‘×—×Ÿ ×§×¦×¨.",
            characterImage: "https://images.unsplash.com/photo-1520975682045-481d9c6b09fb?q=80&w=1200&auto=format&fit=crop",
            challengeType: "boss",
            boss: { name: "The Etiquette Wraith", phases: 2, hp: 110 },
            reward: { souls: 560, relic: true, relicName: "Charm of Please" },
            risk: "×˜×¢×•×™×•×ª = ×¤×’×™×¢×” ×’×“×•×œ×”",
            tip: "×—×¤×©×™ ××™×œ×•×ª × ×™××•×¡ ×•×ª×’×•×‘×•×ª ×˜×‘×¢×™×•×ª.",
            unitData: {
              boss: {
                phase1: { type: "dialogue",
                  dialogue: [
                    {
                      npc: "Wraith",
                      line: "Ask for help politely.",
                      options: [
                        { text: "Can you help me, please?", correct: true },
                        { text: "Help me now.", correct: false },
                        { text: "Bag kitchen.", correct: false }
                      ]
                    },
                    {
                      npc: "Wraith",
                      line: "Say thank you.",
                      options: [
                        { text: "Thank you!", correct: true },
                        { text: "No.", correct: false },
                        { text: "Sleep chair.", correct: false }
                      ]
                    }
                  ]
                },
                phase2: { type: "quiz",
                  quiz: [
                    { q: "Choose the polite sentence:", a: "Can I come in, please?", options: ["Come in!", "Can I come in, please?", "Kitchen desk"], tip: "× ×™××•×¡" },
                    { q: "A polite response to 'Thank you' is:", a: "You're welcome.", options: ["You're welcome.", "Bag!", "Teacher."], tip: "×ª×©×•×‘×” ×× ×•××¡×ª" }
                  ]
                }
              }
            },
            successMessage: "×”×‘×•×¡ × ××¡. ×”××¡×“×¨×•× ×•×ª ×—×–×¨×• ×œ×”×™×•×ª ×©×§×˜×™×."
          }
        ]
      },

      {
        worldId: "W3",
        title: "×¢×•×œ× 3 - ×”×¢×™×¨ ×©××ª×—×ª ×œ×‘××”",
        tagline: "××ª×—×ª ×œ××¦×˜×“×™×•×Ÿ ××¡×ª×ª×¨×ª ×¢×™×¨ ×©×œ×˜×•× ×™×ª ×©×œ ×©×“×™× - ×•×”×—×•×§×™× ×©× ×‘×× ×’×œ×™×ª.",
        icon: "ğŸŸï¸",
        stages: [
          {
            stageId: 9,
            worldId: "W3",
            title: "×©×•×§ ×”×¦×œ×œ×™×",
            narrative: "×¡×•×—×¨×™-×¨×•×—×•×ª ××—×œ×™×¤×™× ××™×œ×™×. ×ª×¦×˜×¨×›×™ ×œ×–×”×•×ª ××ª ×”××™×œ×” ×”× ×›×•× ×” ×œ×¤×™ ×¨××–.",
            characterImage: "https://images.unsplash.com/photo-1520975682037-6e9b5563c8bf?q=80&w=1200&auto=format&fit=crop",
            challengeType: "quiz",
            reward: { souls: 420, relic: false },
            risk: "××¤×©×¨×•×™×•×ª ××‘×œ×‘×œ×•×ª",
            tip: "×§×¨××™ ××ª ×”×¨××– ×‘×¢×‘×¨×™×ª, ×•×¢× ×™ ×‘×× ×’×œ×™×ª.",
            unitData: {
              quiz: [
                { q: "I am not hungry. I don't want to ____.", a: "eat", options: ["eat", "sleep", "desk"], tip: "×œ××›×•×œ" },
                { q: "At night I ____.", a: "sleep", options: ["sleep", "teacher", "kitchen"], tip: "×œ×™×©×•×Ÿ" },
                { q: "My ____ sings with me.", a: "sister", options: ["sister", "house", "bag"], tip: "××—×•×ª" }
              ]
            },
            successMessage: "×¡×•×—×¨×™ ×”×¦×œ×œ×™× × ×¡×•×’×•."
          },
          {
            stageId: 10,
            worldId: "W3",
            title: "×—×“×¨ ×”×—×–×¨×•×ª ×”×©× ×™ - ×©×“×¨×•×’",
            narrative: "××•×ª×• ×—×“×¨, ××‘×œ ×”×©×“ ×œ×•××“. ×”×¤×¢× ×¦×¨×™×š ×”×ª×××•×ª ×¢× ×™×•×ª×¨ ××™×œ×™× ×•×‘×–××Ÿ ×§×¦×¨.",
            characterImage: "https://images.unsplash.com/photo-1497032205916-ac775f0649ae?q=80&w=1200&auto=format&fit=crop",
            challengeType: "match",
            reward: { souls: 460, relic: true, relicName: "Lens of Speed" },
            risk: "×‘××¦×‘ ×§×©×” - ×¤×—×•×ª ×–××Ÿ ×‘×™×Ÿ × ×™×¡×™×•× ×•×ª",
            tip: "×ª×ª×¨×›×–×™ ×‘×–×•×’×•×ª ×•××œ ×ª×’×¨×¨×™ - ×˜×¢×•×™×•×ª ×¢×•×œ×•×ª ×‘×™×•×§×¨.",
            unitData: {
              vocabulary: [
                { id: 301, en: "morning", he: "×‘×•×§×¨" },
                { id: 302, en: "evening", he: "×¢×¨×‘" },
                { id: 303, en: "mother", he: "×××" },
                { id: 304, en: "father", he: "××‘×" },
                { id: 305, en: "kitchen", he: "××˜×‘×—" },
                { id: 306, en: "house", he: "×‘×™×ª" }
              ]
            },
            successMessage: "×”×—×“×¨ ×”×™×˜×”×¨. ××ª ××ª×§×“××ª ××”×¨."
          },
          {
            stageId: 11,
            worldId: "W3",
            title: "××‘×—×Ÿ ×”×”××–× ×” - ×§×•×œ ×”×× ×”×œ",
            narrative: "×§×•×œ ×¢××•×§ ×‘×•×§×¢ ××”×¨××§×•×œ×™×. ×¨×§ ××™ ×©××–×”×” ××ª ×”××™×œ×™× ×™××©×™×š.",
            characterImage: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=1200&auto=format&fit=crop",
            challengeType: "listening",
            reward: { souls: 500, relic: false },
            risk: "××™×œ×™× ××¨×•×›×•×ª ×™×•×ª×¨",
            tip: "×”×©××¢×”, ×•××– ×‘×—×™×¨×”. ×× ×¦×¨×™×š - ×”×©××¢×” ×©×•×‘.",
            unitData: {
              listening: [
                { word: "mother", options: ["mother", "brother", "teacher"] },
                { word: "kitchen", options: ["kitchen", "house", "class"] },
                { word: "evening", options: ["morning", "evening", "sister"] },
                { word: "brother", options: ["brother", "father", "desk"] }
              ]
            },
            successMessage: "×”×§×•×œ ×©×§×˜. ×”×“×œ×ª × ×¤×ª×—×”."
          },
          {
            stageId: 12,
            worldId: "W3",
            title: "×‘×•×¡ ×¢×•×œ× 3 - ×©×“ ×”×©×ª×™×§×” (The Silence King)",
            narrative: "×”×‘×•×¡ ×× ×¡×” ×œ×”×©×ª×™×§ ××ª ×”××•×–×™×§×” ×œ× ×¦×—. ×”×§×¨×‘ ×”×¡×•×¤×™: ×”×§×œ×“×” ××“×•×™×§×ª ×•××– ×©××œ×•×Ÿ ××”×™×¨.",
            characterImage: "https://images.unsplash.com/photo-1493225255756-d9584f8606e9?q=80&w=1200&auto=format&fit=crop",
            challengeType: "boss",
            boss: { name: "The Silence King", phases: 2, hp: 130 },
            reward: { souls: 900, relic: true, relicName: "Mic of Dawn" },
            risk: "×§×¨×‘ ××¨×•×š - ×œ×©××•×¨ ×¢×œ ×¨×™×›×•×–",
            tip: "××œ ×ª××”×¨×™ ×‘×”×§×œ×“×” - ×“×™×•×§ ×œ×¤× ×™ ××”×™×¨×•×ª.",
            unitData: {
              boss: {
                phase1: { type: "typing",
                  typing: [
                    { prompt: "We cook ramen in the ____.", answer: "kitchen", hint: "××˜×‘×—" },
                    { prompt: "My ____ sings with me.", answer: "sister", hint: "××—×•×ª" },
                    { prompt: "Good ____! (after 6pm)", answer: "evening", hint: "×¢×¨×‘" }
                  ]
                },
                phase2: { type: "quiz",
                  quiz: [
                    { q: "We practice dance in the _____.", a: "class", options: ["kitchen", "class", "bag"], tip: "××™×¤×” ××ª××× ×™×?" },
                    { q: "I put my mic in my _____.", a: "bag", options: ["chair", "bag", "father"], tip: "××™×¤×” ×©××™× ×“×‘×¨×™×?" },
                    { q: "My _____ is my dad.", a: "father", options: ["father", "desk", "sleep"], tip: "××‘×" },
                    { q: "At night I ____.", a: "sleep", options: ["sleep", "eat", "chair"], tip: "×œ×™×©×•×Ÿ" }
                  ]
                }
              }
            },
            successMessage: "ğŸ‰ ×”×”×•×¤×¢×” × ×™×¦×œ×”! ××ª ×¦×™×™×“×ª ××’×“×™×ª. ×¡×™×™××ª ××ª ×©×œ×•×©×ª ×”×¢×•×œ××•×ª ×”×¨××©×•× ×™×!"
          }
        ]
      }
    ];

    // -----------------------------
    // GLOBAL STATE + PERSISTENCE
    // -----------------------------
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;
    let userId = null;

    // Progress model
    let globalScore = 0;
    let globalHighScore = 0;

    let playerProgress = {
      currentStageId: 1,
      completedStages: {},
      relics: {},
      hardMode: false
    };

    let currentStageData = null;

    // -----------------------------
    // DOM REFS
    // -----------------------------
    const views = {
      map: document.getElementById('map-view'),
      challenge: document.getElementById('stage-challenge-view'),
      game: document.getElementById('game-view')
    };

    const elements = {
      worldsList: document.getElementById('worlds-list'),
      stageTitle: document.getElementById('stage-title'),
      stageMeta: document.getElementById('stage-meta'),
      stageNarrative: document.getElementById('stage-narrative'),
      stageImg: document.getElementById('stage-character-img'),
      instructions: document.getElementById('challenge-instructions'),
      tip: document.getElementById('challenge-tip'),
      rewardText: document.getElementById('reward-text'),
      riskText: document.getElementById('risk-text'),
      relicBonusText: document.getElementById('relic-bonus-text'),

      gameTitle: document.getElementById('game-title'),
      gameSubtitle: document.getElementById('game-subtitle'),
      gameContent: document.getElementById('game-content'),

      score: document.getElementById('current-score'),
      highScore: document.getElementById('high-score'),
      relicsCount: document.getElementById('relics-count'),
      feedback: document.getElementById('feedback-message'),

      nextBtn: document.getElementById('next-button'),
      endQuizBtn: document.getElementById('end-quiz-button'),

      bossBar: document.getElementById('boss-bar'),
      bossName: document.getElementById('boss-name'),
      bossPhase: document.getElementById('boss-phase'),
      bossHp: document.getElementById('boss-hp'),

      loading: document.getElementById('loading-overlay'),
      userId: document.getElementById('user-id-display'),
      hardModeInd: document.getElementById('hard-mode-ind')
    };

    // -----------------------------
    // Helpers
    // -----------------------------
    const flattenStages = () => WORLDS.flatMap(w => w.stages);

    function relicsTotal() {
      return Object.keys(playerProgress.relics || {}).length;
    }

    function relicBonusMultiplier() {
      // Tiny, harmless bonus: +1% per relic (cap 10%)
      const bonus = Math.min(0.10, relicsTotal() * 0.01);
      return 1 + bonus;
    }

    function awardRelicIfAny(stage) {
      if (stage.reward?.relic && stage.reward?.relicName) {
        playerProgress.relics[stage.reward.relicName] = true;
      }
    }

    function hardPenalty() {
      return playerProgress.hardMode ? 2 : 1;
    }

    function formatStageType(t) {
      const m = {
        match: "×”×ª×××•×ª",
        flashcards: "×›×¨×˜×™×¡×™×•×ª",
        quiz: "×©××œ×•×Ÿ",
        typing: "×”×§×œ×“×”",
        listening: "×”××–× ×”",
        dialogue: "×“×™××œ×•×’",
        boss: "×‘×•×¡"
      };
      return m[t] || t;
    }

    // -----------------------------
    // Init App
    // -----------------------------
    async function initApp() {
      // Render immediately (offline-safe)
      window.AdventureGame.renderMap();

      // Try firebase
      try {
        if (Object.keys(firebaseConfig).length > 0) {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
          else await signInAnonymously(auth);

          onAuthStateChanged(auth, (user) => {
            if (user) {
              userId = user.uid;
              elements.userId.textContent = `×¦×™×™×“×ª ××—×•×‘×¨×ª: ${userId.substring(0, 6)}...`;
              loadData();
            }
          });
        } else {
          elements.loading.classList.add('opacity-0', 'pointer-events-none');
          elements.userId.textContent = "××¦×‘ ××•×¤×œ×™×™×Ÿ (×œ× ×©×•××¨ ×”×ª×§×“××•×ª)";
          loadLocal();
          updateUI();
        }
      } catch (e) {
        console.error("Auth failed", e);
        elements.loading.classList.add('opacity-0', 'pointer-events-none');
        elements.userId.textContent = "×©×’×™××ª ×—×™×‘×•×¨ (××¦×‘ ××•×¤×œ×™×™×Ÿ)";
        loadLocal();
        updateUI();
      }
    }

    function localKey() {
      return `demon_hunter_local_${appId}`;
    }

    function saveLocal() {
      try {
        const payload = { playerProgress, globalScore, globalHighScore };
        localStorage.setItem(localKey(), JSON.stringify(payload));
      } catch {}
    }

    function loadLocal() {
      try {
        const raw = localStorage.getItem(localKey());
        if (!raw) return;
        const d = JSON.parse(raw);
        playerProgress = d.playerProgress || playerProgress;
        globalScore = d.globalScore || 0;
        globalHighScore = d.globalHighScore || 0;
      } catch {}
    }

    function resetLocal() {
      try { localStorage.removeItem(localKey()); } catch {}
      playerProgress = { currentStageId: 1, completedStages: {}, relics: {}, hardMode: false };
      globalScore = 0;
      globalHighScore = 0;
      updateUI();
      AdventureGame.showView('map-view');
      elements.feedback.textContent = "";
    }

    function loadData() {
      if (!userId || !db) return;
      const ref = doc(db, `artifacts/${appId}/users/${userId}/demon_hunter_progress/data`);
      onSnapshot(ref, (snap) => {
        if (snap.exists()) {
          const d = snap.data();
          playerProgress = d.progress || playerProgress;
          globalHighScore = d.highScore || 0;
          globalScore = d.currentScore || 0;
        } else {
          // maybe restore local if exists
          loadLocal();
        }
        updateUI();
        elements.loading.classList.add('opacity-0', 'pointer-events-none');
      });
    }

    async function saveData() {
      globalHighScore = Math.max(globalHighScore, globalScore);
      updateUI();
      saveLocal();

      if (!userId || !db) return;
      try {
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/demon_hunter_progress/data`), {
          progress: playerProgress,
          highScore: globalHighScore,
          currentScore: globalScore
        }, { merge: true });
      } catch (e) { console.error("Save failed", e); }
    }

    function updateUI() {
      elements.score.textContent = globalScore;
      elements.highScore.textContent = globalHighScore;
      elements.relicsCount.textContent = relicsTotal();
      elements.hardModeInd.textContent = playerProgress.hardMode ? "×“×•×œ×§" : "×›×‘×•×™";
      window.AdventureGame.renderMap();
    }

    // -----------------------------
    // GAME ENGINE
    // -----------------------------
    window.AdventureGame = {
      showView: (name) => {
        Object.values(views).forEach(v => v.classList.add('hidden'));
        document.getElementById(name).classList.remove('hidden');
      },

      toggleHardMode: () => {
        playerProgress.hardMode = !playerProgress.hardMode;
        updateUI();
        saveData();
      },

      resetLocal: () => resetLocal(),

      renderMap: () => {
        const allStages = flattenStages();
        elements.worldsList.innerHTML = "";

        WORLDS.forEach(world => {
          const wrap = document.createElement('div');
          wrap.className = "bg-gray-800/60 border border-gray-700 rounded-2xl p-4";

          const head = document.createElement('div');
          head.className = "flex items-center justify-between mb-3";
          head.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="text-3xl">${world.icon}</div>
              <div>
                <div class="text-xl font-black text-white">${world.title}</div>
                <div class="text-sm text-gray-400">${world.tagline}</div>
              </div>
            </div>
            <div class="text-xs text-gray-400">×©×œ×‘×™×: ${world.stages.length}</div>
          `;

          const grid = document.createElement('div');
          grid.className = "grid grid-cols-1 md:grid-cols-2 gap-3";

          world.stages.forEach(stage => {
            const isDone = !!playerProgress.completedStages[stage.stageId];
            const isCurrent = stage.stageId === playerProgress.currentStageId;
            const isLocked = stage.stageId > playerProgress.currentStageId;

            const div = document.createElement('div');
            
            const statusClass = isDone 
              ? "border-emerald-500 bg-gray-900/40" 
              : (isCurrent ? "border-pink-500 bg-gray-900 ring-2 ring-pink-500/30" : "border-gray-700 bg-gray-900/30 opacity-70");
            
            const lockClass = isLocked ? "stage-locked" : "";
            const typeTag = formatStageType(stage.challengeType);
            const rewardTag = stage.reward?.relic ? `Relic: ${stage.reward.relicName || "×›×Ÿ"}` : `+${stage.reward?.souls || 0} × ×©××•×ª`;

            div.className = `p-4 rounded-2xl border-2 transition relative overflow-hidden ${statusClass} ${lockClass}`;
            div.innerHTML = `
              <div class="flex justify-between items-start relative z-10">
                <div>
                  <div class="text-lg font-bold text-white">${stage.title}</div>
                  <div class="text-xs text-gray-400 mt-1">×©×œ×‘ ${stage.stageId} - ${typeTag}</div>
                </div>
                <div class="text-2xl">${isDone ? "âœ…" : (isLocked ? "ğŸ”’" : "ğŸ”¥")}</div>
              </div>
              <div class="mt-3 flex items-center gap-2 text-xs">
                <span class="px-2 py-1 rounded-full bg-gray-800 border border-gray-700 text-gray-300">${rewardTag}</span>
                ${stage.boss ? `<span class="px-2 py-1 rounded-full bg-purple-900/40 border border-purple-600 text-purple-200">×‘×•×¡</span>` : ""}
              </div>
            `;

            if (!isLocked) div.onclick = () => AdventureGame.prepStage(stage);
            grid.appendChild(div);
          });

          wrap.appendChild(head);
          wrap.appendChild(grid);
          elements.worldsList.appendChild(wrap);
        });
      },

      prepStage: (stage) => {
        currentStageData = stage;
        
        elements.stageTitle.textContent = stage.title;
        elements.stageMeta.textContent = `×©×œ×‘ ${stage.stageId} - ${formatStageType(stage.challengeType)}${stage.boss ? " - ×‘×•×¡" : ""}`;
        elements.stageNarrative.textContent = stage.narrative;
        elements.stageImg.src = stage.characterImage;
        
        const ins = {
          match: "×”×ª××™××™ ×‘×™×Ÿ ××™×œ×™× ×‘×× ×’×œ×™×ª ×œ×‘×™×Ÿ ×”×ª×¨×’×•×.",
          flashcards: "×©×™× ×•×Ÿ: ×”×¤×›×™ ×›×¨×˜×™×¡×™×•×ª ×•×”×©××™×¢×™ ××ª ×”××™×œ×”.",
          quiz: "×¢× ×™ ×¢×œ ×©××œ×•×ª - ×‘×—×¨×™ ××ª ×”×ª×©×•×‘×” ×”× ×›×•× ×”.",
          typing: "×”×©×œ×™××™ ××ª ×”××™×œ×” ×”×—×¡×¨×” ×‘×× ×’×œ×™×ª.",
          listening: "×”×§×©×™×‘×™ ×•×‘×—×¨×™ ××ª ×”××™×œ×” ×©×©××¢×ª.",
          dialogue: "×‘×—×¨×™ ×ª×’×•×‘×” × ×›×•× ×” ×‘×©×™×—×”.",
          boss: "×§×¨×‘ ×¨×‘-×©×œ×‘×™ - ×ª× ×¦×—×™ ×›×œ ×¤××–×”."
        }[stage.challengeType] || "××©×™××”";

        elements.instructions.textContent = ins;
        elements.tip.textContent = stage.tip || "";
        
        const souls = stage.reward?.souls || 0;
        elements.rewardText.textContent = stage.reward?.relic 
          ? `+${souls} × ×©××•×ª + Relic` 
          : `+${souls} × ×©××•×ª`;
        
        elements.riskText.textContent = stage.risk || "××™×Ÿ";
        elements.relicBonusText.textContent = `×‘×•× ×•×¡ ×¦×‘×™×¨×”: +${Math.round((relicBonusMultiplier() - 1) * 100)}% ×œ× ×™×§×•×“`;

        AdventureGame.showView('stage-challenge-view');
      },

      startChallenge: () => {
        elements.gameTitle.textContent = currentStageData.title;
        elements.gameSubtitle.textContent = `×¡×•×’: ${formatStageType(currentStageData.challengeType)}${playerProgress.hardMode ? " - ××¦×‘ ×§×©×”" : ""}`;

        elements.gameContent.innerHTML = "";
        elements.feedback.textContent = "";
        elements.nextBtn.classList.add('hidden');
        elements.endQuizBtn.classList.add('hidden');

        // Boss bar default
        elements.bossBar.classList.add('hidden');
        elements.bossName.textContent = "";
        elements.bossPhase.textContent = "";
        elements.bossHp.style.width = "100%";

        AdventureGame.showView('game-view');

        const type = currentStageData.challengeType;
        const data = currentStageData.unitData;

        if (type === "match") window.GameMatch.init(data.vocabulary);
        else if (type === "flashcards") window.GameFlashcards.init(data.vocabulary);
        else if (type === "quiz") window.GameQuiz.init(data.quiz);
        else if (type === "typing") window.GameTyping.init(data.typing);
        else if (type === "listening") window.GameListening.init(data.listening);
        else if (type === "dialogue") window.GameDialogue.init(data.dialogue);
        else if (type === "boss") window.GameBoss.init(data.boss, currentStageData.boss);
      },

      completeStage: () => {
        const stage = currentStageData;
        const id = stage.stageId;

        const already = !!playerProgress.completedStages[id];
        if (!already) {
          playerProgress.completedStages[id] = true;
          playerProgress.currentStageId = id + 1;
          
          // award souls + relic
          const baseSouls = stage.reward?.souls || 0;
          const souls = Math.round(baseSouls * relicBonusMultiplier());
          globalScore += souls;

          awardRelicIfAny(stage);
          
          elements.feedback.textContent = stage.successMessage || "×”×©×œ×‘ ×”×•×©×œ×!";
          elements.feedback.className = "text-2xl font-bold text-green-400 animate-bounce";

          saveData();
        } else {
          elements.feedback.textContent = "×©×œ×‘ ×”×•×©×œ× ×©×•×‘! (×œ×œ× ×¤×¨×¡ ×©×œ×‘)";
          elements.feedback.className = "text-xl font-bold text-gray-400";
          saveData();
        }

        setTimeout(() => {
          AdventureGame.showView('map-view');
        }, 2200);
      },

      addScore: (pts) => {
        const p = Math.round(pts * relicBonusMultiplier());
        globalScore += p;
        elements.score.textContent = globalScore;
        saveLocal();
      },

      damageBoss: (amount, bossState) => {
        bossState.hp = Math.max(0, bossState.hp - amount);
        const pct = Math.max(0, Math.min(100, Math.round((bossState.hp / bossState.maxHp) * 100)));
        elements.bossHp.style.width = `${pct}%`;
      },

      setBossUI: (name, phase, bossState) => {
        elements.bossBar.classList.remove('hidden');
        elements.bossName.textContent = `ğŸ‘‘ ${name}`;
        elements.bossPhase.textContent = `×©×œ×‘ ${phase} ××ª×•×š ${bossState.phases}`;
      }
    };

    // -----------------------------
    // GAME: MATCH
    // -----------------------------
    window.GameMatch = {
      selected: [],
      remaining: 0,

      init: (vocab) => {
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-2 gap-4 w-full max-w-lg';

        let cards = [];
        const take = Math.min(6, vocab.length);
        const chosen = vocab.slice(0, take);

        chosen.forEach(w => {
          cards.push({ id: w.id, text: w.en, type: 'en' });
          cards.push({ id: w.id, text: w.he, type: 'he' });
        });

        cards.sort(() => Math.random() - 0.5);

        cards.forEach(c => {
          const el = document.createElement('div');
          el.className = 'game-card bg-gray-800 p-4 rounded-xl text-center text-lg font-bold text-white select-none';
          el.textContent = c.text;
          el.onclick = () => window.GameMatch.click(el, c);
          grid.appendChild(el);
        });

        elements.gameContent.appendChild(grid);
        window.GameMatch.remaining = chosen.length;
        window.GameMatch.selected = [];
      },

      click: (el, data) => {
        if (el.classList.contains('invisible')) return;
        
        if (el.classList.contains('selected')) {
          el.classList.remove('selected');
          window.GameMatch.selected = window.GameMatch.selected.filter(i => i.el !== el);
          return;
        }

        el.classList.add('selected');
        window.GameMatch.selected.push({ el, data });

        if (window.GameMatch.selected.length === 2) window.GameMatch.check();
      },

      check: () => {
        const [a, b] = window.GameMatch.selected;
        const penalty = playerProgress.hardMode ? -12 : -6;

        if (a.data.id === b.data.id && a.data.type !== b.data.type) {
          a.el.classList.add('correct-match');
          b.el.classList.add('correct-match');
          AdventureGame.addScore(playerProgress.hardMode ? 28 : 20);
          
          setTimeout(() => {
            a.el.classList.add('invisible');
            b.el.classList.add('invisible');
            window.GameMatch.remaining--;
            if (window.GameMatch.remaining === 0) AdventureGame.completeStage();
          }, 450);
        } else {
          a.el.classList.add('incorrect-match');
          b.el.classList.add('incorrect-match');
          AdventureGame.addScore(penalty);
          
          setTimeout(() => {
            a.el.classList.remove('incorrect-match', 'selected');
            b.el.classList.remove('incorrect-match', 'selected');
          }, 450);
        }

        window.GameMatch.selected = [];
      }
    };

    // -----------------------------
    // GAME: FLASHCARDS
    // -----------------------------
    window.GameFlashcards = {
      list: [], idx: 0, 

      init: (vocab) => {
        window.GameFlashcards.list = vocab;
        window.GameFlashcards.idx = 0;
        window.GameFlashcards.render();
      },

      render: () => {
        if (window.GameFlashcards.idx >= window.GameFlashcards.list.length) {
          AdventureGame.completeStage();
          return;
        }

        const w = window.GameFlashcards.list[window.GameFlashcards.idx];

        elements.gameContent.innerHTML = `
          <div class="w-full max-w-sm h-64 cursor-pointer" onclick="this.firstElementChild.classList.toggle('rotate-y-180')">
            <div class="relative w-full h-full transition-transform duration-700 transform-style-3d">
              <div class="absolute inset-0 bg-gradient-to-br from-pink-600 to-purple-800 rounded-2xl flex items-center justify-center backface-hidden shadow-xl border-2 border-pink-400">
                <div class="text-center">
                  <h3 class="text-4xl font-bold text-white">${w.en}</h3>
                  <p class="mt-2 text-xs text-pink-200">×œ×—×¦×™ ×œ×”×¤×•×š</p>
                </div>
              </div>
              <div class="absolute inset-0 bg-gray-800 rounded-2xl flex items-center justify-center backface-hidden rotate-y-180 border-2 border-purple-500">
                <h3 class="text-3xl font-bold text-white">${w.he}</h3>
              </div>
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="window.speakEnglish('${w.en}')" class="px-6 py-2 bg-gray-700 rounded-full hover:bg-gray-600">ğŸ”Š ×”×©××¢×”</button>
            <button onclick="window.GameFlashcards.next()" class="px-6 py-2 bg-green-600 rounded-full hover:bg-green-500 font-bold">×”×‘× â”</button>
          </div>
        `;
      },

      next: () => {
        window.GameFlashcards.idx++;
        AdventureGame.addScore(playerProgress.hardMode ? 14 : 10);
        window.GameFlashcards.render();
      }
    };

    // -----------------------------
    // GAME: QUIZ
    // -----------------------------
    window.GameQuiz = {
      list: [], idx: 0, corrects: 0,

      init: (quiz) => {
        window.GameQuiz.list = quiz;
        window.GameQuiz.idx = 0;
        window.GameQuiz.corrects = 0;
        window.GameQuiz.render();
      },

      render: () => {
        if (window.GameQuiz.idx >= window.GameQuiz.list.length) {
          elements.gameContent.innerHTML = `
            <div class="w-full max-w-lg bg-gray-800 p-6 rounded-2xl border border-gray-700 text-center">
              <h3 class="text-3xl font-bold text-white mb-2">×”××‘×—×Ÿ ×”×¡×ª×™×™×!</h3>
              <p class="text-gray-300">×ª×©×•×‘×•×ª × ×›×•× ×•×ª: <span class="font-black text-emerald-300">${window.GameQuiz.corrects}</span> ××ª×•×š ${window.GameQuiz.list.length}</p>
              <p class="text-xs text-gray-400 mt-3">×œ×—×¦×™ ×œ×¡×™×•× ×›×“×™ ×œ××©×¨ × ×™×¦×—×•×Ÿ ×‘×©×œ×‘.</p>
            </div>
          `;
          elements.endQuizBtn.classList.remove('hidden');
          return;
        }

        const q = window.GameQuiz.list[window.GameQuiz.idx];
        const opts = [...q.options].sort(() => Math.random() - 0.5);

        let html = `
          <div class="w-full max-w-lg bg-gray-800 p-6 rounded-2xl border border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm text-purple-300">×©××œ×” ${window.GameQuiz.idx + 1}</h3>
              <span class="text-xs text-gray-400">${q.tip || ""}</span>
            </div>
            <p class="text-2xl font-bold text-white mb-6">${q.q}</p>
            <div class="grid gap-3">
        `;

        opts.forEach(o => {
          html += `<button onclick="window.GameQuiz.ans(this, '${o.replaceAll("'", "\\'")}', '${q.a.replaceAll("'", "\\'")}')" class="quiz-opt w-full text-right p-4 rounded-xl bg-gray-900 hover:bg-gray-700 border border-gray-600 transition">${o}</button>`;
        });

        html += `</div></div>`;
        elements.gameContent.innerHTML = html;
      },

      ans: (el, val, correct) => {
        const btns = document.querySelectorAll('.quiz-opt');
        btns.forEach(b => b.disabled = true);

        const good = (val === correct);
        if (good) {
          el.classList.add('bg-green-900', 'border-green-500');
          window.GameQuiz.corrects++;
          AdventureGame.addScore(playerProgress.hardMode ? 65 : 50);
        } else {
          el.classList.add('bg-red-900', 'border-red-500');
          AdventureGame.addScore(playerProgress.hardMode ? -22 : -12);
        }

        setTimeout(() => {
          window.GameQuiz.idx++;
          window.GameQuiz.render();
        }, playerProgress.hardMode ? 800 : 1000);
      },

      finishQuiz: () => {
        AdventureGame.completeStage();
      }
    };

    // -----------------------------
    // GAME: TYPING SPELL
    // -----------------------------
    window.GameTyping = {
      list: [], idx: 0, mistakes: 0,
      init: (items) => {
        window.GameTyping.list = items;
        window.GameTyping.idx = 0;
        window.GameTyping.mistakes = 0;
        window.GameTyping.render();
      },
      render: () => {
        if (window.GameTyping.idx >= window.GameTyping.list.length) {
          AdventureGame.completeStage();
          return;
        }
        const it = window.GameTyping.list[window.GameTyping.idx];
        const hard = playerProgress.hardMode;

        // Create Word Bank (unique answers)
        const allAnswers = [...new Set(window.GameTyping.list.map(i => i.answer))].sort();
        const bankHtml = `
          <div class="mb-6 bg-gray-900/50 p-3 rounded-xl border border-gray-700">
            <div class="text-xs text-gray-400 mb-2 text-center">××—×¡×Ÿ ××™×œ×™× (Word Bank)</div>
            <div class="flex flex-wrap justify-center gap-2">
              ${allAnswers.map(w => `<span class="px-3 py-1 bg-gray-800 border border-gray-600 rounded text-pink-300 font-mono text-sm select-all cursor-pointer hover:bg-gray-700" onclick="document.getElementById('typing-input').value = '${w}'; document.getElementById('typing-input').focus();">${w}</span>`).join('')}
            </div>
          </div>
        `;

        elements.gameContent.innerHTML = `
          <div class="w-full max-w-lg bg-gray-800 p-6 rounded-2xl border border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm text-purple-300">×œ×—×©×™× ×‘×”×§×œ×“×” ${window.GameTyping.idx + 1}/${window.GameTyping.list.length}</div>
              <div class="text-xs text-gray-400">×˜×¢×•×™×•×ª: <span class="text-amber-300 font-bold">${window.GameTyping.mistakes}</span>${hard ? " (××§×¡' 2)" : ""}</div>
            </div>

            ${bankHtml}

            <p class="text-2xl font-bold text-white mb-3" dir="ltr">${it.prompt}</p>
            <p class="text-sm text-gray-400 mb-4">×¨××–: <span class="text-gray-200 font-bold">${it.hint || ""}</span></p>
            <div class="flex gap-2">
              <input id="typing-input" class="flex-1 bg-gray-900 border border-gray-700 rounded-xl px-4 py-3 text-white outline-none focus:border-pink-500" placeholder="×”×§×œ×™×“×™ ×›××Ÿ..." autocomplete="off" />
              <button id="typing-check" class="px-5 py-3 rounded-xl bg-pink-600 hover:bg-pink-500 font-bold">×‘×“×™×§×”</button>
            </div>
            <div class="flex gap-2 mt-3">
              <button onclick="window.speakEnglish('${it.answer}')" class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-sm">ğŸ”Š ×”×©××¢×”</button>
              <button id="typing-skip" class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-sm">×¨××– ×—×–×§ (-× ×§')</button>
            </div>
          </div>
        `;

        const input = document.getElementById('typing-input');
        const btn = document.getElementById('typing-check');
        const skip = document.getElementById('typing-skip');

        const check = () => {
          const v = (input.value || "").trim().toLowerCase();
          const ans = (it.answer || "").trim().toLowerCase();

          if (v === ans) {
            AdventureGame.addScore(playerProgress.hardMode ? 55 : 40);
            elements.feedback.textContent = "âœ¨ ×¤×’×™×¢×” ××“×•×™×§×ª!";
            elements.feedback.className = "text-2xl font-bold text-emerald-300";
            window.GameTyping.idx++;
            setTimeout(() => { elements.feedback.textContent = ""; window.GameTyping.render(); }, 650);
          } else {
            window.GameTyping.mistakes++;
            AdventureGame.addScore(playerProgress.hardMode ? -18 : -10);
            elements.feedback.textContent = "âŒ ×©×’×•×™. × ×¡×™ ×©×•×‘!";
            elements.feedback.className = "text-2xl font-bold text-red-300";
            input.classList.add("border-red-500");
            setTimeout(() => { input.classList.remove("border-red-500"); }, 450);

            if (playerProgress.hardMode && window.GameTyping.mistakes >= 2) {
              elements.feedback.textContent = "×”×—×•×ª× × ×¡×’×¨! × ×¡×™ ×©×•×‘ ×‘×¤×¢× ××—×¨×ª.";
              elements.feedback.className = "text-xl font-bold text-gray-300";
              setTimeout(() => AdventureGame.showView('map-view'), 1400);
              return;
            }
          }
        };

        btn.onclick = check;
        input.addEventListener('keydown', (e) => { if (e.key === "Enter") check(); });

        skip.onclick = () => {
          AdventureGame.addScore(playerProgress.hardMode ? -28 : -18);
          input.value = it.answer;
          input.focus();
        };

        input.focus();
      }
    };

    // -----------------------------
    // GAME: LISTENING TRAP
    // -----------------------------
    window.GameListening = {
      list: [], idx: 0,
      init: (items) => {
        window.GameListening.list = items;
        window.GameListening.idx = 0;
        window.GameListening.render();
      },
      render: () => {
        if (window.GameListening.idx >= window.GameListening.list.length) {
          AdventureGame.completeStage();
          return;
        }
        const it = window.GameListening.list[window.GameListening.idx];
        const opts = [...it.options].sort(() => Math.random() - 0.5);

        let html = `
          <div class="w-full max-w-lg bg-gray-800 p-6 rounded-2xl border border-gray-700 text-center">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm text-purple-300">×”××–× ×” ${window.GameListening.idx + 1}/${window.GameListening.list.length}</div>
              <button onclick="window.speakEnglish('${it.word}')" class="px-4 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-sm">ğŸ”Š ×”×©××¢×”</button>
            </div>
            <p class="text-gray-300 mb-4">×©××¢×ª×™ ××™×œ×”. ××” ×”×™×?</p>
            <div class="grid gap-3">
        `;

        opts.forEach(o => {
          html += `<button onclick="window.GameListening.pick(this, '${o.replaceAll("'", "\\'")}', '${it.word.replaceAll("'", "\\'")}')" class="listen-opt w-full text-right p-4 rounded-xl bg-gray-900 hover:bg-gray-700 border border-gray-600 transition">${o}</button>`;
        });

        html += `</div></div>`;
        elements.gameContent.innerHTML = html;

        // auto speak once
        setTimeout(() => window.speakEnglish(it.word), 250);
      },

      pick: (el, val, correct) => {
        const btns = document.querySelectorAll('.listen-opt');
        btns.forEach(b => b.disabled = true);

        if (val === correct) {
          el.classList.add('bg-green-900', 'border-green-500');
          AdventureGame.addScore(playerProgress.hardMode ? 60 : 45);
          elements.feedback.textContent = "ğŸ‘‚âœ… ×©××™×¢×” ×—×“×”!";
          elements.feedback.className = "text-2xl font-bold text-emerald-300";
        } else {
          el.classList.add('bg-red-900', 'border-red-500');
          AdventureGame.addScore(playerProgress.hardMode ? -24 : -12);
          elements.feedback.textContent = "ğŸ‘‚âŒ ×œ×. × ×¡×™ ×©×•×‘ ×‘×©×œ×‘ ×”×‘×.";
          elements.feedback.className = "text-2xl font-bold text-red-300";
        }

        setTimeout(() => {
          elements.feedback.textContent = "";
          window.GameListening.idx++;
          window.GameListening.render();
        }, playerProgress.hardMode ? 800 : 1000);
      }
    };

    // -----------------------------
    // GAME: DIALOGUE DUEL
    // -----------------------------
    window.GameDialogue = {
      list: [], idx: 0,
      init: (items) => {
        window.GameDialogue.list = items;
        window.GameDialogue.idx = 0;
        window.GameDialogue.render();
      },
      render: () => {
        if (window.GameDialogue.idx >= window.GameDialogue.list.length) {
          AdventureGame.completeStage();
          return;
        }

        const it = window.GameDialogue.list[window.GameDialogue.idx];
        const opts = [...it.options].sort(() => Math.random() - 0.5);

        let html = `
          <div class="w-full max-w-lg bg-gray-800 p-6 rounded-2xl border border-gray-700">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm text-purple-300">×“×™××œ×•×’ ${window.GameDialogue.idx + 1}/${window.GameDialogue.list.length}</div>
              <div class="text-xs text-gray-400">NPC: <span class="text-gray-200 font-bold">${it.npc || "??"}</span></div>
            </div>
            <div class="bg-gray-900 border border-gray-700 rounded-xl p-4 text-white mb-4">
              <div class="text-xs text-gray-400 mb-1">×”×•× ××•××¨:</div>
              <div class="text-xl font-bold">${it.line}</div>
            </div>
            <div class="grid gap-3">
        `;

        opts.forEach(o => {
          html += `<button onclick="window.GameDialogue.pick(this, ${o.correct}, '${o.text.replaceAll("'", "\\'")}')" class="dlg-opt w-full text-right p-4 rounded-xl bg-gray-900 hover:bg-gray-700 border border-gray-600 transition">${o.text}</button>`;
        });

        html += `</div></div>`;
        elements.gameContent.innerHTML = html;
      },

      pick: (el, correct) => {
        const btns = document.querySelectorAll('.dlg-opt');
        btns.forEach(b => b.disabled = true);

        if (correct) {
          el.classList.add('bg-green-900', 'border-green-500');
          AdventureGame.addScore(playerProgress.hardMode ? 70 : 50);
          elements.feedback.textContent = "ğŸ—£ï¸âœ¨ ×ª×©×•×‘×” ××•×©×œ××ª!";
          elements.feedback.className = "text-2xl font-bold text-emerald-300";
        } else {
          el.classList.add('bg-red-900', 'border-red-500');
          AdventureGame.addScore(playerProgress.hardMode ? -26 : -14);
          elements.feedback.textContent = "ğŸ—£ï¸âŒ ×œ× ×˜×‘×¢×™. × ×¡×™ ×œ×‘×—×•×¨ ××©×¤×˜ ××œ× ×•× ×›×•×Ÿ.";
          elements.feedback.className = "text-2xl font-bold text-red-300";
        }

        setTimeout(() => {
          elements.feedback.textContent = "";
          window.GameDialogue.idx++;
          window.GameDialogue.render();
        }, playerProgress.hardMode ? 800 : 1000);
      }
    };

    // -----------------------------
    // GAME: BOSS (multi-phase)
    // -----------------------------
    window.GameBoss = {
      bossData: null,
      bossMeta: null,
      state: null,
      phase: 1,

      init: (bossData, bossMeta) => {
        window.GameBoss.bossData = bossData;
        window.GameBoss.bossMeta = bossMeta || { name: "Boss", phases: 2, hp: 100 };
        window.GameBoss.phase = 1;

        window.GameBoss.state = { 
          phases: window.GameBoss.bossMeta.phases || 2, 
          maxHp: window.GameBoss.bossMeta.hp || 100, 
          hp: window.GameBoss.bossMeta.hp || 100
        };

        AdventureGame.setBossUI(window.GameBoss.bossMeta.name || "Boss", window.GameBoss.phase, window.GameBoss.state);
        window.GameBoss.runPhase();
      },

      runPhase: () => {
        const p = window.GameBoss.phase;
        const st = window.GameBoss.state;

        AdventureGame.setBossUI(window.GameBoss.bossMeta.name || "Boss", p, st);

        if (p === 1) {
          // phase1
          const phase1 = window.GameBoss.bossData.phase1;
          if (phase1.type === "match") {
            window.GameMatch.init(phase1.vocabulary);
            
            // Wrap Match completion for boss
            const originalComplete = AdventureGame.completeStage;
            AdventureGame.completeStage = () => {}; // prevent full completion

            // Patch: when match remaining hits 0, phase win:
            const checkInterval = setInterval(() => {
              if (window.GameMatch.remaining === 0) {
                clearInterval(checkInterval);
                AdventureGame.completeStage = originalComplete;

                AdventureGame.damageBoss(playerProgress.hardMode ? 55 : 45, st);
                elements.feedback.textContent = "âš”ï¸ ×¤××–×” 1 ×”×•×©×œ××”! ×”×‘×•×¡ × ×—×œ×©.";
                elements.feedback.className = "text-2xl font-bold text-emerald-300";
                setTimeout(() => {
                  elements.feedback.textContent = "";
                  window.GameBoss.phase = 2;
                  window.GameBoss.runPhase();
                }, 900);
              }
            }, 150);
            
            // Add extra scoring side effects already handled by GameMatch
            return;
          }

          if (phase1.type === "dialogue") {
            window.GameDialogue.init(phase1.dialogue);

            const checkInterval = setInterval(() => {
              if (window.GameDialogue.idx >= window.GameDialogue.list.length) {
                clearInterval(checkInterval);
                AdventureGame.damageBoss(playerProgress.hardMode ? 55 : 45, st);
                elements.feedback.textContent = "âš”ï¸ ×¤××–×” 1 ×”×•×©×œ××”! ×”×‘×•×¡ × ×¡×“×§.";
                elements.feedback.className = "text-2xl font-bold text-emerald-300";
                setTimeout(() => {
                  elements.feedback.textContent = "";
                  window.GameBoss.phase = 2;
                  window.GameBoss.runPhase();
                }, 900);
              }
            }, 200);
            return;
          }

          if (phase1.type === "typing") {
            window.GameTyping.init(phase1.typing);
            const checkInterval = setInterval(() => {
              if (window.GameTyping.idx >= window.GameTyping.list.length) {
                clearInterval(checkInterval);
                AdventureGame.damageBoss(playerProgress.hardMode ? 55 : 45, st);
                elements.feedback.textContent = "âš”ï¸ ×¤××–×” 1 ×”×•×©×œ××”! ×”×‘×•×¡ ××ª×¢×¨×¢×¨.";
                elements.feedback.className = "text-2xl font-bold text-emerald-300";
                setTimeout(() => {
                  elements.feedback.textContent = "";
                  window.GameBoss.phase = 2;
                  window.GameBoss.runPhase();
                }, 900);
              }
            }, 200);
            return;
          }
        }

        // phase2: quiz by default
        const phase2 = window.GameBoss.bossData.phase2;
        if (phase2.type === "quiz") {
          window.GameQuiz.init(phase2.quiz);

          // Replace finish behavior: boss dies, then stage complete
          const originalFinish = window.GameQuiz.finishQuiz;
          window.GameQuiz.finishQuiz = () => {
            AdventureGame.damageBoss(playerProgress.hardMode ? 75 : 65, st);
            
            elements.feedback.textContent = "ğŸ‘‘ ×”×‘×•×¡ ×”×•×‘×¡! ×”××•×–×™×§×” ×—×•×–×¨×ª!";
            elements.feedback.className = "text-2xl font-bold text-green-400 animate-bounce";

            // Restore
            window.GameQuiz.finishQuiz = originalFinish;
            
            setTimeout(() => {
              AdventureGame.completeStage();
            }, 900);
          };

          elements.endQuizBtn.classList.remove('hidden');
          return;
        }

        // fallback
        elements.gameContent.innerHTML = `<div class="text-center text-gray-200">×©×’×™××”: ×¤××–×” ×œ× × ×ª××›×ª.</div>`;
      }
    };

    // -----------------------------
    // TTS
    // -----------------------------
    window.speakEnglish = async function(text) {
      try {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      } catch {}
    };

    // -----------------------------
    // RUN
    // -----------------------------
    window.addEventListener('load', initApp);

  </script>
</body>
</html>
